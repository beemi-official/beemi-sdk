<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ping Game - Beemi SDK Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .ping-display {
            font-size: 4em;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            transform: none;
        }
        
        .room-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .players {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .player {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .player.leader {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }
        
        .logs {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üèì Ping Game</h1>
        <p>A simple multiplayer game demonstrating the Beemi SDK</p>
        
        <div id="status" class="status">
            Click "Join Game" to start playing!
        </div>
        
        <div id="gameControls">
            <button onclick="joinGame()">üéÆ Join Game</button>
            <button onclick="hostGame()">üè† Host Game</button>
        </div>
        
        <div id="gameArea" style="display: none;">
            <div id="roomInfo" class="room-info"></div>
            
            <div id="pingDisplay" class="ping-display">Waiting...</div>
            
            <div id="players" class="players"></div>
            
            <button onclick="shareRoom()">üì§ Share Room</button>
            <button onclick="leaveGame()">üö™ Leave Game</button>
        </div>
        
        <div id="logs" class="logs"></div>
    </div>

    <script type="module">
        import { host, quickPlay, crdt, mutex } from './beemi-sdk-0.1.js';

        // Mock WebSocket for demo (replace with real server in production)
        class MockWebSocket {
            constructor(url) {
                this.url = url;
                this.readyState = 1;
                setTimeout(() => {
                    this.onopen && this.onopen();
                    log('üîó Connected to Beemi server');
                }, 100);
            }

            send(data) {
                const message = JSON.parse(data);
                log(`üì§ ${message.type}: ${JSON.stringify(message).substring(0, 50)}...`);
                
                setTimeout(() => {
                    this.simulateServerResponse(message);
                }, 200);
            }

            simulateServerResponse(message) {
                let response;
                
                switch (message.type) {
                    case 'createRoom':
                        response = {
                            type: 'roomCreated',
                            roomId: 'ping_' + Math.random().toString(36).substr(2, 9),
                            joinCode: Math.random().toString(36).substr(2, 6).toUpperCase(),
                            gameId: 'ping',
                            maxPlayers: 4,
                            members: [{ id: 'player1', name: 'You' }],
                            leaderId: 'player1'
                        };
                        break;
                    case 'quickPlay':
                        response = {
                            type: 'roomJoined',
                            roomId: 'ping_' + Math.random().toString(36).substr(2, 9),
                            joinCode: Math.random().toString(36).substr(2, 6).toUpperCase(),
                            gameId: 'ping',
                            role: Math.random() > 0.7 ? 'leader' : 'peer',
                            members: [
                                { id: 'player1', name: 'Host' },
                                { id: 'player2', name: 'You' }
                            ],
                            leaderId: 'player1'
                        };
                        break;
                    case 'lock':
                        response = {
                            type: 'lockAcquired',
                            roomId: message.roomId,
                            key: message.key
                        };
                        break;
                }

                if (response) {
                    this.onmessage && this.onmessage({ data: JSON.stringify(response) });
                }
            }

            close() {
                this.onclose && this.onclose();
            }
        }

        // Replace WebSocket globally
        window.WebSocket = MockWebSocket;

        // Game state
        let currentRoom = null;
        let pingCount = 0;
        let isLeader = false;
        let pingInterval = null;

        // Utility functions
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
            
            // Keep only last 20 log entries
            while (logElement.children.length > 20) {
                logElement.removeChild(logElement.firstChild);
            }
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        function updatePingDisplay(count) {
            document.getElementById('pingDisplay').textContent = `Ping #${count}`;
        }

        function updateRoomInfo(room) {
            const roomInfoEl = document.getElementById('roomInfo');
            roomInfoEl.innerHTML = `
                <div><strong>Room:</strong> ${room.code}</div>
                <div><strong>Role:</strong> ${room.role === 'leader' ? 'üëë Leader' : 'üë§ Player'}</div>
                <div><strong>Players:</strong> ${room.members.length}/${room.maxPlayers}</div>
            `;
        }

        function updatePlayers(members, leaderId) {
            const playersEl = document.getElementById('players');
            playersEl.innerHTML = members.map(member => `
                <div class="player ${member.id === leaderId ? 'leader' : ''}">
                    ${member.id === leaderId ? 'üëë' : 'üë§'} ${member.name || member.id}
                </div>
            `).join('');
        }

        // Game functions
        window.hostGame = async function() {
            try {
                updateStatus('Creating room...', 'info');
                currentRoom = await host('ping', { max: 4 });
                
                isLeader = currentRoom.role === 'leader';
                log(`üè† Room created! Code: ${currentRoom.code}`);
                
                setupGame();
            } catch (error) {
                log(`‚ùå Failed to create room: ${error.message}`);
                updateStatus('Failed to create room', 'error');
            }
        };

        window.joinGame = async function() {
            try {
                updateStatus('Joining game...', 'info');
                currentRoom = await quickPlay('ping', { max: 4 });
                
                isLeader = currentRoom.role === 'leader';
                log(`üéÆ Joined room! Code: ${currentRoom.code} Role: ${currentRoom.role}`);
                
                setupGame();
            } catch (error) {
                log(`‚ùå Failed to join game: ${error.message}`);
                updateStatus('Failed to join game', 'error');
            }
        };

        function setupGame() {
            // Show game area
            document.getElementById('gameControls').style.display = 'none';
            document.getElementById('gameArea').style.display = 'block';
            
            updateRoomInfo(currentRoom);
            updatePlayers(currentRoom.members, currentRoom.leaderId);
            updateStatus('Connected! Game starting...', 'success');

            // Set up event listeners
            currentRoom.on('ping', (data) => {
                pingCount = data.count;
                updatePingDisplay(pingCount);
                log(`üèì Ping #${pingCount} from ${data.from}`);
            });

            // Leader-only game logic
            currentRoom.ifLeader(() => {
                log('üëë You are the leader! Starting ping sequence...');
                updateStatus('You are the leader! Pinging...', 'success');
                
                // Use CRDT to track game state
                crdt.set('gameStarted', true);
                crdt.set('pingCount', 0);
                
                // Start pinging every 2 seconds with mutex for safety
                pingInterval = setInterval(async () => {
                    try {
                        await mutex.exec('pingLock', 1000, () => {
                            const newCount = pingCount + 1;
                            currentRoom.emit('ping', { 
                                count: newCount, 
                                from: 'leader',
                                timestamp: Date.now()
                            });
                            
                            // Update CRDT
                            crdt.set('pingCount', newCount);
                            
                            return newCount;
                        });
                    } catch (error) {
                        log(`‚ö†Ô∏è Ping error: ${error.message}`);
                    }
                }, 2000);
            });

            // Watch for CRDT changes
            crdt.watch('gameStarted', (value) => {
                if (value) {
                    log('üéÆ Game started by leader!');
                    if (!isLeader) {
                        updateStatus('Game started! Watching for pings...', 'info');
                    }
                }
            });

            crdt.watch('pingCount', (count) => {
                if (count > pingCount) {
                    pingCount = count;
                    updatePingDisplay(count);
                }
            });
        }

        window.shareRoom = function() {
            if (!currentRoom) return;
            
            const shareLink = currentRoom.shareLink();
            if (navigator.clipboard) {
                navigator.clipboard.writeText(shareLink).then(() => {
                    log(`üìã Share link copied: ${shareLink}`);
                    updateStatus('Share link copied to clipboard!', 'success');
                }).catch(() => {
                    log(`üîó Share link: ${shareLink}`);
                });
            } else {
                log(`üîó Share link: ${shareLink}`);
            }
        };

        window.leaveGame = function() {
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
            
            currentRoom = null;
            isLeader = false;
            pingCount = 0;
            
            document.getElementById('gameControls').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            
            updateStatus('Left the game. Click to join another!', 'info');
            updatePingDisplay(0);
            log('üö™ Left the game');
        };

        // Initialize
        log('üöÄ Ping Game initialized');
        log('üí° This game demonstrates all Beemi SDK features:');
        log('   ‚Ä¢ Room management (host/join)');
        log('   ‚Ä¢ Event bus (ping events)');
        log('   ‚Ä¢ Leader election (ping coordination)');
        log('   ‚Ä¢ CRDT (shared game state)');
        log('   ‚Ä¢ Mutex (exclusive ping generation)');
        log('   ‚Ä¢ Share links (room sharing)');
    </script>
</body>
</html> 